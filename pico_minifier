#!/usr/bin/perl -Iminifier_lib/
use strict;
use warnings;
use experimental 'smartmatch';
use Alanxoc3::Pico8FormatUtil;
use Getopt::Long qw(GetOptions);

my $dev_mode;
GetOptions('dev' => \$dev_mode) or die "Usage: $0 [--dev]\n";

# Constants specific to Zeldo.
my %constants;

# Colors
$constants{'FG_YELLOW'} = '10';
$constants{'BG_YELLOW'} = '9';
$constants{'FG_WHITE'} = '7';
$constants{'BG_WHITE'} = '5';
$constants{'FG_RED'} = '8';
$constants{'BG_RED'} = '2';
$constants{'FG_GREEN'} = '11';
$constants{'BG_GREEN'} = '3';
$constants{'FG_UI'} = '13';
$constants{'BG_UI'} = '1';
$constants{'SL_UI'} = '2';
$constants{'BG'} = '0';

# Other
$constants{'FADE_TIME'} = '.5';
$constants{'MAX_ENERGY'} = '100';
$constants{'INTERACT_SPACE'} = '.5';
$constants{'FPS'} = '60';
$constants{'CART_NAME'} = '"zeldo_test5"';
$constants{'TEMP_SAVE_LOCATION'} = '0x5d00';
$constants{'REAL_SAVE_LOCATION'} = '0x5e00';
$constants{'SAVE_LENGTH'}        = '64';
$constants{'FIRST_ITEM_COST'} = '10';
$constants{'LANK_START_HEALTH'} = '10';

# Save states (up to 256).
$constants{'VERSION'}        = '0'  ;
$constants{'HARD_MODE'}      = '1'  ;
$constants{'SAVE_SPOT'}      = '2'  ;
$constants{'MONEY'}          = '3'  ; # Used
$constants{'HEALTH'}         = '4'  ;
$constants{'HAS_FORCE'}      = '5'  ; # Used
$constants{'HAS_BOOMERANG'}  = '6'  ; # Used
$constants{'HAS_BOMB'}       = '7'  ; # Used
$constants{'HAS_SHIELD'}     = '8'  ; # Used
$constants{'ALWAYS_TRUE'}    = '9'  ; # Used
$constants{'HAS_BOW'}        = '10' ; # Used
$constants{'HAS_SHOVEL'}     = '11' ; # Used
$constants{'HAS_SWORD'}      = '12' ; # Used
$constants{'HAS_BANJO'}      = '13' ; # Used
$constants{'LARK_DANCE'}     = '14' ; # Used
$constants{'NAVY_DANCE'}     = '15' ;
$constants{'KEEP_DANCE'}     = '16' ; # Used
$constants{'JANE_DANCE'}     = '17' ; # Used
$constants{'BOB_DANCE'}      = '18' ; # Used
$constants{'CHICKEN_1'}      = '19' ;
$constants{'CHICKEN_2'}      = '20' ;
$constants{'CHICKEN_3'}      = '21' ;
$constants{'CHICKEN_4'}      = '22' ;
$constants{'CHICKEN_5'}      = '23' ;
$constants{'SOUP_DELIVERED'} = '24' ;
$constants{'GHOST_1'}        = '25' ;
$constants{'GHOST_2'}        = '26' ;
$constants{'GHOST_3'}        = '27' ;
$constants{'GHOST_4'}        = '28' ;
$constants{'FOREST_BOSS'}    = '29' ;
$constants{'GRAVE_BOSS'}     = '30' ;
$constants{'CANNON_BOSS'}    = '31' ;
$constants{'IVAN_BOSS'}      = '32' ;

$constants{'KEY'}            = '33' ;
$constants{'LETTER'}         = '34' ; # Used
$constants{'BOB_OUT'}        = '35' ; # Used
$constants{'BANJO_TUNED'}    = '36' ; # Used
$constants{'NAVY_OUT'}       = '37' ; # Used

$constants{'POT_00'}         = '38' ; # Used
$constants{'POT_01'}         = '39' ; # Used
$constants{'POT_02'}         = '40' ; # Used
$constants{'POT_03'}         = '41' ; # Used
$constants{'POT_04'}         = '42' ; # Used
$constants{'POT_05'}         = '43' ; # Used
$constants{'POT_06'}         = '44' ; # Used
$constants{'POT_07'}         = '45' ; # Used
$constants{'POT_08'}         = '46' ; # Used
$constants{'POT_09'}         = '47' ; # Used
$constants{'POT_10'}         = '48' ; # Used
$constants{'POT_11'}         = '49' ; # Used
$constants{'POT_12'}         = '50' ; # Used
$constants{'POT_13'}         = '51' ; # Used
$constants{'POT_14'}         = '52' ; # Used
$constants{'POT_15'}         = '53' ; # Used
$constants{'POT_16'}         = '54' ; # Used
$constants{'POT_17'}         = '55' ; # Used
$constants{'POT_18'}         = '56' ; # Used
$constants{'POT_19'}         = '57' ; # Used
$constants{'POT_20'}         = '58' ; # Used
$constants{'POT_21'}         = '59' ; # Used
$constants{'POT_22'}         = '60' ; # Used
$constants{'POT_23'}         = '61' ; # Used
$constants{'POT_24'}         = '62' ; # Used
$constants{'POT_25'}         = '63' ; # Used
$constants{'POT_26'}         = '64' ; # Used
$constants{'POT_27'}         = '65' ; # Used
$constants{'POT_28'}         = '66' ; # Used
$constants{'POT_29'}         = '67' ; # Used

$constants{'BOGUS_SPOT'}   = '255'; # Used

# Rooms
$constants{'VILLAGE_PATH'}            = '1';
$constants{'LANK_HOUSE'}              = '2';
$constants{'MAYOR_HOUSE'}             = '3';
$constants{'TEACH_STUDIO'}            = '4';
$constants{'SHOP'}                    = '5';
$constants{'JANEBOB'}                 = '6';
$constants{'LIMENAVY'}                = '7';
$constants{'VILLAGE'}                 = '8';
$constants{'LANK_FRONT_YARD'}         = '9';
$constants{'FIELD'}                   = '10';
$constants{'GRAVEYARD_ENTRANCE'}      = '11';
$constants{'GRAVEYARD'}               = '12';
$constants{'GRAVEYARD_END'}           = '13';
$constants{'CANYON_START'}            = '14';
$constants{'CANYON_PATH'}             = '15';
$constants{'CANYON_END'}              = '16';
$constants{'FOREST_ENTRANCE'}         = '17';
$constants{'FOREST_LOST'}             = '18';
$constants{'FOREST_1'}                = '19';
$constants{'FOREST_2'}                = '20';
$constants{'FOREST_3'}                = '21';
$constants{'FOREST_4'}                = '22';
$constants{'FOREST_BOSS'}             = '23';
$constants{'FOREST_TREASURE'}         = '24';
$constants{'FOREST_SECRET'}           = '25';

# Go through the actual minifying.
my @lines = <>;
chomp(@lines);
@lines = remove_comments(@lines);
@lines = remove_texts(@lines);
@lines = tokenize_lines(\@lines, \%constants);
@lines = single_quotes_to_double(@lines);

if ($dev_mode) {
   @lines = remove_spaces(@lines);
} else {
   @lines = remove_spaces(@lines);
   my %vars = populate_vars(@lines);
   @lines = tokenize_lines(\@lines, \%vars);
}

# Uncomment for each thing to go on its own line.
# Note that this is slightly more compression space.
# $lines[0] =~ s/([^\"]) ([^\"])/$1\n$2/g;
@lines = pop_text_logics(@lines);

my $file = join($dev_mode ? "\n" : "\n", @lines);
$file = multiline_string_replace($file);
print $file;
